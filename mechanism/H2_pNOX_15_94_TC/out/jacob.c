#include "jacob.h"

void eval_jacob (const double t, const double pres, const double * __restrict__ y, double * __restrict__ jac) {

  double T = y[0];

  // average molecular weight
  double mw_avg;
  // mass-averaged density
  double rho;
  // species molar concentrations
  double conc[16];
  double y_N;
  eval_conc(y[0], pres, &y[1], &y_N, &mw_avg, &rho, conc);

  // evaluate reaction rates
  double fwd_rates[47];
  double rev_rates[47];
  eval_rxn_rates (T, pres, conc, fwd_rates, rev_rates);

  double pres_mod[7];
  //get pressure modifications to reaction rates
  get_rxn_pres_mod (T, pres, conc, pres_mod);

  // evaluate rate of change of species molar concentration
  double spec_rates[16] = {0};
  eval_spec_rates (fwd_rates, rev_rates, pres_mod, spec_rates, &spec_rates[15]);

  double m = pres / (8.31446210e+03 * T);
  double logT = log(T);
  double dBdT[16];
  if (T <= 1000.0) {
    dBdT[0] = (1.5000000000000000e+00 + 2.5473660000000000e+04 / T) / T + 0.0000000000000000e+00 + T * (0.0000000000000000e+00 + T * (0.0000000000000000e+00 + 0.0000000000000000e+00 * T));
    dBdT[1] = (1.3443311200000001e+00 + -9.1793517299999996e+02 / T) / T + 3.9902603749999996e-03 + T * (-6.4927169999999995e-06 + T * (5.0393023500000001e-09 + -1.4752235220000002e-12 * T));
    dBdT[2] = (3.1986352000000000e+00 + -3.0293725999999999e+04 / T) / T + -1.0182008500000000e-03 + T * (2.1734471999999999e-06 + T * (-1.3719817250000000e-09 + 3.5439360000000003e-13 * T));
    dBdT[3] = (3.3151514899999999e+00 + -1.7706743699999999e+04 / T) / T + -4.2369531099999998e-04 + T * (5.8801441000000001e-06 + T * (-5.6690735999999996e-09 + 1.8179003160000000e-12 * T));
    dBdT[4] = (3.3017980700000003e+00 + 2.6401848500000000e+02 / T) / T + -2.3745604850000002e-03 + T * (7.0527635000000006e-06 + T * (-6.0690978500000002e-09 + 1.8584504500000003e-12 * T));
    dBdT[5] = (1.5000000000000000e+00 + 5.6104637999999999e+04 / T) / T + 0.0000000000000000e+00 + T * (0.0000000000000000e+00 + T * (0.0000000000000000e+00 + 0.0000000000000000e+00 * T));
    dBdT[6] = (2.5310052800000000e+00 + -1.0469762800000001e+03 / T) / T + -6.1830494000000001e-05 + T * (-1.6766647766666668e-07 + T * (6.0882653000000001e-10 + -2.8176247000000003e-13 * T));
    dBdT[7] = (1.2571501999999999e+00 + 8.7417746000000006e+03 / T) / T + 5.6523640000000000e-03 + T * (-4.5571063333333328e-06 + T * (2.4204950750000002e-09 + -5.8614363999999997e-13 * T));
    dBdT[8] = (2.4929503700000000e+00 + 4.2105972199999997e+04 / T) / T + 1.5589786000000001e-04 + T * (-4.9635542666666661e-07 + T * (6.2041850499999997e-10 + -2.0714183200000001e-13 * T));
    dBdT[9] = (3.1919801600000000e+00 + 2.1186328600000001e+04 / T) / T + -1.0230141349999999e-03 + T * (2.2258537800000002e-06 + T * (-1.3122680875000001e-09 + 3.1117989600000001e-13 * T));
    dBdT[10] = (3.2547463199999997e+00 + 2.8793207999999999e+04 / T) / T + -1.7254914900000000e-03 + T * (4.5929566333333333e-06 + T * (-3.3315936000000000e-09 + 8.8204679400000002e-13 * T));
    dBdT[11] = (3.2185989599999996e+00 + 9.8450996400000004e+03 / T) / T + -2.3199406200000001e-03 + T * (3.6814349666666670e-06 + T * (-2.3351387675000000e-09 + 5.6110974799999994e-13 * T));
    dBdT[12] = (2.1682671000000000e+00 + 2.9122259200000000e+04 / T) / T + -1.6396594200000000e-03 + T * (2.2143546533333334e-06 + T * (-1.5320165600000000e-09 + 4.2253194199999998e-13 * T));
    dBdT[13] = (2.7824563599999999e+00 + -1.0639435599999999e+03 / T) / T + -1.4983670799999999e-03 + T * (3.2824340033333332e-06 + T * (-2.4203237725000002e-09 + 6.4874567400000000e-13 * T));
    dBdT[14] = (2.9919842399999999e+00 + 3.3688983600000001e+03 / T) / T + -1.2005332749999999e-03 + T * (1.5388801100000001e-06 + T * (-9.6979076500000001e-10 + 2.7263900399999999e-13 * T));
  } else {
    dBdT[0] = (1.5000000000000000e+00 + 2.5473660000000000e+04 / T) / T + 0.0000000000000000e+00 + T * (0.0000000000000000e+00 + T * (0.0000000000000000e+00 + 0.0000000000000000e+00 * T));
    dBdT[1] = (1.9328657499999999e+00 + -8.1306558099999995e+02 / T) / T + 4.1330401299999997e-04 + T * (-4.8800788000000007e-08 + T * (3.8525103499999999e-12 + -1.3776095999999999e-16 * T));
    dBdT[2] = (1.6770388999999999e+00 + -2.9885894000000000e+04 / T) / T + 1.4865907999999999e-03 + T * (-2.5792296333333332e-07 + T * (2.3608378500000001e-11 + -8.5379982000000002e-16 * T));
    dBdT[3] = (3.5797730500000000e+00 + -1.8007177500000002e+04 / T) / T + 2.0266300150000001e-03 + T * (-4.3281576666666668e-07 + T * (4.9552849999999997e-11 + -2.2793758399999999e-15 * T));
    dBdT[4] = (3.1722874100000000e+00 + 3.1020683900000002e+01 / T) / T + 9.4058813500000002e-04 + T * (-1.1542576200000000e-07 + T * (4.8664387250000001e-12 + 3.5251380999999999e-17 * T));
    dBdT[5] = (1.4159429000000001e+00 + 5.6133775000000001e+04 / T) / T + 8.7445325000000003e-05 + T * (-3.9674563333333332e-08 + T * (7.5565609999999996e-12 + -4.0721966000000000e-16 * T));
    dBdT[6] = (1.9525763700000001e+00 + -9.2394868799999995e+02 / T) / T + 6.9845020000000005e-04 + T * (-1.6421053433333334e-07 + T * (1.9650254875000001e-11 + -9.2151040799999995e-16 * T));
    dBdT[7] = (3.8230728999999997e+00 + 8.0734047000000000e+03 / T) / T + 1.3135125499999999e-03 + T * (-3.1950290666666668e-07 + T * (4.0001779999999998e-11 + -1.9550460400000000e-15 * T));
    dBdT[8] = (1.7837264400000001e+00 + 4.2346194499999998e+04 / T) / T + 6.6492943999999995e-04 + T * (-1.4159519100000000e-07 + T * (1.9587361050000000e-11 + -1.1009026200000001e-15 * T));
    dBdT[9] = (1.5926304899999999e+00 + 2.1573732000000000e+04 / T) / T + 1.7384179850000001e-03 + T * (-3.6090541333333336e-07 + T * (3.7335639499999997e-11 + -1.1504823740000002e-15 * T));
    dBdT[10] = (2.4274442299999999e+00 + 2.8767602599999998e+04 / T) / T + 1.6164761699999999e-03 + T * (-3.9098766333333333e-07 + T * (4.7627089000000001e-11 + -2.2898301200000000e-15 * T));
    dBdT[11] = (2.2607123400000000e+00 + 9.9214313199999997e+03 / T) / T + 5.9550567499999998e-04 + T * (-1.4304088199999999e-07 + T * (1.7362036574999999e-11 + -8.0659136199999995e-16 * T));
    dBdT[12] = (1.5436369700000001e+00 + 2.9226011999999999e+04 / T) / T + -1.3658124299999999e-05 + T * (-1.3967650666666665e-09 + T * (1.2387046125000000e-12 + -9.5910738799999993e-17 * T));
    dBdT[13] = (2.6609606499999998e+00 + -1.2159771800000001e+03 / T) / T + 3.2818290550000001e-04 + T * (-4.7049875666666662e-08 + T * (5.1449483749999997e-12 + -2.5982687200000003e-16 * T));
    dBdT[14] = (1.8385303300000002e+00 + 3.6978080799999998e+03 / T) / T + 5.5370644500000001e-04 + T * (-9.8000069666666654e-08 + T * (1.0517468224999999e-11 + -4.8457978000000002e-16 * T));
  }

  eval_jacob_0(pres, conc, fwd_rates, rev_rates, pres_mod, spec_rates, m, mw_avg, rho, dBdT, T, jac);
  eval_jacob_1(pres, conc, fwd_rates, rev_rates, pres_mod, spec_rates, m, mw_avg, rho, dBdT, T, jac);
  // species enthalpies
  double h[16];
  eval_h(T, h);

  // species specific heats
  double cp[16];
  eval_cp(T, cp);

  // average specific heat
  double cp_avg;
  cp_avg = (y[1] * cp[0]) + (y[2] * cp[1]) + (y[3] * cp[2]) + (y[4] * cp[3]) + 
     (y[5] * cp[4]) + (y[6] * cp[5]) + (y[7] * cp[6]) + (y[8] * cp[7]) + 
     (y[9] * cp[8]) + (y[10] * cp[9]) + (y[11] * cp[10]) + (y[12] * cp[11]) + 
     (y[13] * cp[12]) + (y[14] * cp[13]) + (y[15] * cp[14]) + (y_N * cp[15]);
  jac[0] = 0.0;
  double working_temp = 0;
  //Finish dYk / Yj's
  //And dT/dYj's
  eval_jacob_2(mw_avg, rho, cp_avg, spec_rates, h, cp, jac);
  if (T <= 1000.0) {
    working_temp = (y[1] * 8.2484743055555555e+03 * (0.0000000000000000e+00 + T * (0.0000000000000000e+00 + T * (0.0000000000000000e+00 + 0.0000000000000000e+00 * T))))
    + (y[2] * 4.1242371527777777e+03 * (7.9805207499999992e-03 + T * (-3.8956301999999997e-05 + T * (6.0471628200000004e-08 + -2.9504470440000002e-11 * T))))
    + (y[3] * 4.6152995281709690e+02 * (-2.0364017000000000e-03 + T * (1.3040683200000000e-05 + T * (-1.6463780699999999e-08 + 7.0878720000000001e-12 * T))))
    + (y[4] * 2.4444235020873757e+02 * (-8.4739062199999996e-04 + T * (3.5280864600000001e-05 + T * (-6.8028883199999996e-08 + 3.6358006320000000e-11 * T))))
    + (y[5] * 2.5190759558868086e+02 * (-4.7491209700000004e-03 + T * (4.2316581000000002e-05 + T * (-7.2829174200000009e-08 + 3.7169009000000002e-11 * T))))
    + (y[6] * 5.9359335332333842e+02 * (0.0000000000000000e+00 + T * (0.0000000000000000e+00 + T * (0.0000000000000000e+00 + 0.0000000000000000e+00 * T))))
    + (y[7] * 2.9679667666166921e+02 * (-1.2366098800000000e-04 + T * (-1.0059988660000001e-06 + T * (7.3059183600000005e-09 + -5.6352494000000003e-12 * T))))
    + (y[8] * 1.8890923363551681e+02 * (1.1304728000000000e-02 + T * (-2.7342637999999999e-05 + T * (2.9045940900000003e-08 + -1.1722872800000000e-11 * T))))
    + (y[9] * 5.5374372960372966e+02 * (3.1179572000000002e-04 + T * (-2.9781325599999999e-06 + T * (7.4450220599999993e-09 + -4.1428366400000001e-12 * T))))
    + (y[10] * 5.1890795107033648e+02 * (-2.0460282699999999e-03 + T * (1.3355122680000000e-05 + T * (-1.5747217049999999e-08 + 6.2235979200000000e-12 * T))))
    + (y[11] * 2.8648825373854322e+02 * (-3.4509829800000000e-03 + T * (2.7557739800000002e-05 + T * (-3.9979123200000003e-08 + 1.7640935880000001e-11 * T))))
    + (y[12] * 2.7709331800306609e+02 * (-4.6398812400000001e-03 + T * (2.2088609800000001e-05 + T * (-2.8021665210000002e-08 + 1.1222194960000000e-11 * T))))
    + (y[13] * 5.1968636164760301e+02 * (-3.2793188399999999e-03 + T * (1.3286127919999999e-05 + T * (-1.8384198720000000e-08 + 8.4506388399999997e-12 * T))))
    + (y[14] * 2.5984318082380150e+02 * (-2.9967341599999998e-03 + T * (1.9694604020000000e-05 + T * (-2.9043885270000002e-08 + 1.2974913480000000e-11 * T))))
    + (y[15] * 4.8888470041747513e+02 * (-2.4010665499999998e-03 + T * (9.2332806600000008e-06 + T * (-1.1637489180000001e-08 + 5.4527800800000000e-12 * T))))
    + (y_N * 2.0812170463078849e+02 * (0.0000000000000000e+00 + T * (0.0000000000000000e+00 + T * (0.0000000000000000e+00 + 0.0000000000000000e+00 * T))));
  } else {
    working_temp = (y[1] * 8.2484743055555555e+03 * (0.0000000000000000e+00 + T * (0.0000000000000000e+00 + T * (0.0000000000000000e+00 + 0.0000000000000000e+00 * T))))
    + (y[2] * 4.1242371527777777e+03 * (8.2660802599999995e-04 + T * (-2.9280472800000003e-07 + T * (4.6230124199999999e-11 + -2.7552192000000000e-15 * T))))
    + (y[3] * 4.6152995281709690e+02 * (2.9731815999999999e-03 + T * (-1.5475377800000000e-06 + T * (2.8330054200000001e-10 + -1.7075996400000000e-14 * T))))
    + (y[4] * 2.4444235020873757e+02 * (4.0532600300000002e-03 + T * (-2.5968946000000000e-06 + T * (5.9463419999999994e-10 + -4.5587516799999997e-14 * T))))
    + (y[5] * 2.5190759558868086e+02 * (1.8811762700000000e-03 + T * (-6.9255457200000001e-07 + T * (5.8397264700000001e-11 + 7.0502761999999997e-16 * T))))
    + (y[6] * 5.9359335332333842e+02 * (1.7489065000000001e-04 + T * (-2.3804737999999999e-07 + T * (9.0678731999999996e-11 + -8.1443932000000000e-15 * T))))
    + (y[7] * 2.9679667666166921e+02 * (1.3969004000000001e-03 + T * (-9.8526320600000006e-07 + T * (2.3580305850000002e-10 + -1.8430208160000000e-14 * T))))
    + (y[8] * 1.8890923363551681e+02 * (2.6270250999999999e-03 + T * (-1.9170174400000002e-06 + T * (4.8002136000000002e-10 + -3.9100920799999997e-14 * T))))
    + (y[9] * 5.5374372960372966e+02 * (1.3298588799999999e-03 + T * (-8.4957114600000003e-07 + T * (2.3504833260000003e-10 + -2.2018052400000001e-14 * T))))
    + (y[10] * 5.1890795107033648e+02 * (3.4768359700000002e-03 + T * (-2.1654324800000001e-06 + T * (4.4802767399999999e-10 + -2.3009647480000002e-14 * T))))
    + (y[11] * 2.8648825373854322e+02 * (3.2329523399999998e-03 + T * (-2.3459259800000001e-06 + T * (5.7152506800000006e-10 + -4.5796602399999998e-14 * T))))
    + (y[12] * 2.7709331800306609e+02 * (1.1910113500000000e-03 + T * (-8.5824529199999997e-07 + T * (2.0834443889999998e-10 + -1.6131827239999999e-14 * T))))
    + (y[13] * 5.1968636164760301e+02 * (-2.7316248599999999e-05 + T * (-8.3805903999999992e-09 + T * (1.4864455349999999e-11 + -1.9182147759999999e-15 * T))))
    + (y[14] * 2.5984318082380150e+02 * (6.5636581100000002e-04 + T * (-2.8229925399999997e-07 + T * (6.1739380499999999e-11 + -5.1965374400000003e-15 * T))))
    + (y[15] * 4.8888470041747513e+02 * (1.1074128900000000e-03 + T * (-5.8800041799999995e-07 + T * (1.2620961869999999e-10 + -9.6915956000000007e-15 * T))))
    + (y_N * 2.0812170463078849e+02 * (0.0000000000000000e+00 + T * (0.0000000000000000e+00 + T * (0.0000000000000000e+00 + 0.0000000000000000e+00 * T))));
  }


  //Complete dT wrt T calculations
  jac[0] = -(spec_rates[0] * 1.00800000e+00 * (-working_temp * h[0] / cp_avg + cp[0]) + jac[1] * h[0] * rho
    + spec_rates[1] * 2.01600000e+00 * (-working_temp * h[1] / cp_avg + cp[1]) + jac[2] * h[1] * rho
    + spec_rates[2] * 1.80150000e+01 * (-working_temp * h[2] / cp_avg + cp[2]) + jac[3] * h[2] * rho
    + spec_rates[3] * 3.40140000e+01 * (-working_temp * h[3] / cp_avg + cp[3]) + jac[4] * h[3] * rho
    + spec_rates[4] * 3.30060000e+01 * (-working_temp * h[4] / cp_avg + cp[4]) + jac[5] * h[4] * rho
    + spec_rates[5] * 1.40070000e+01 * (-working_temp * h[5] / cp_avg + cp[5]) + jac[6] * h[5] * rho
    + spec_rates[6] * 2.80140000e+01 * (-working_temp * h[6] / cp_avg + cp[6]) + jac[7] * h[6] * rho
    + spec_rates[7] * 4.40130000e+01 * (-working_temp * h[7] / cp_avg + cp[7]) + jac[8] * h[7] * rho
    + spec_rates[8] * 1.50150000e+01 * (-working_temp * h[8] / cp_avg + cp[8]) + jac[9] * h[8] * rho
    + spec_rates[9] * 1.60230000e+01 * (-working_temp * h[9] / cp_avg + cp[9]) + jac[10] * h[9] * rho
    + spec_rates[10] * 2.90220000e+01 * (-working_temp * h[10] / cp_avg + cp[10]) + jac[11] * h[10] * rho
    + spec_rates[11] * 3.00060000e+01 * (-working_temp * h[11] / cp_avg + cp[11]) + jac[12] * h[11] * rho
    + spec_rates[12] * 1.59990000e+01 * (-working_temp * h[12] / cp_avg + cp[12]) + jac[13] * h[12] * rho
    + spec_rates[13] * 3.19980000e+01 * (-working_temp * h[13] / cp_avg + cp[13]) + jac[14] * h[13] * rho
    + spec_rates[14] * 1.70070000e+01 * (-working_temp * h[14] / cp_avg + cp[14]) + jac[15] * h[14] * rho
    + spec_rates[15] * 3.99500000e+01 * (-working_temp * h[15] / cp_avg + cp[15])) / (rho * cp_avg);
} // end eval_jacob

